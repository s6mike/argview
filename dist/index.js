var jQuery=$=require("jquery"),_=require("underscore"),Hammer=require("jquery-hammerjs/jquery.hammer-full.js"),MAPJS=require("mindmup-mapjs-layout");require("jquery.hotkeys");var MAPJS=MAPJS||{},observable=function(a){"use strict";var b=[];return a.addEventListener=function(a,c,d){a.split(" ").forEach(function(a){a&&b.push({type:a,listener:c,priority:d||0})})},a.listeners=function(a){return b.filter(function(b){return b.type===a}).map(function(a){return a.listener})},a.removeEventListener=function(a,c){b=b.filter(function(a){return a.listener!==c})},a.dispatchEvent=function(a){var c=Array.prototype.slice.call(arguments,1);b.filter(function(b){return b.type===a}).sort(function(a,b){return b.priority-a.priority}).some(function(a){try{return a.listener.apply(void 0,c)===!1}catch(b){console.log("dispatchEvent failed",b,a)}})},a};MAPJS.content=function(a,b){"use strict";var c,d=function(){c=void 0},e=function B(b){return b=b||a,b.ideas?_.reduce(b.ideas,function(a,b){return Math.max(a,B(b))},parseInt(b.id,10)||0):parseInt(b.id,10)||0},f=function(a){return a=a||b,c||(c=e()),c+=1,a?c+"."+a:c},g=function(a,b){return a.id?d():a.id=f(b),a.ideas&&_.each(a.ideas,function(c,d){a.ideas[parseFloat(d)]=g(c,b)}),a.title||(a.title=""),a.containsDirectChild=a.findChildRankById=function(b){return parseFloat(_.reduce(a.ideas,function(a,c,d){return c.id==b?d:a},void 0))},a.findSubIdeaById=function(b){var c=_.find(a.ideas,function(a){return a.id==b});return c||_.reduce(a.ideas,function(a,c){return a||c.findSubIdeaById(b)},void 0)},a.find=function(b){var c=b(a)?[_.pick(a,"id","title")]:[];return 0===_.size(a.ideas)?c:_.reduce(a.ideas,function(a,c){return _.union(a,c.find(b))},c)},a.getAttr=function(b){return a.attr&&a.attr[b]?_.clone(a.attr[b]):!1},a.sortedSubIdeas=function(){if(!a.ideas)return[];var b=[],c=_.groupBy(_.map(_.keys(a.ideas),parseFloat),function(a){return a>0}),d=_.sortBy(c[!0],Math.abs).concat(_.sortBy(c[!1],Math.abs));return _.each(d,function(c){b.push(a.ideas[c])}),b},a.traverse=function(b,c){c||b(a),_.each(a.sortedSubIdeas(),function(a){a.traverse(b,c)}),c&&b(a)},a},h=function(a,b){if(b=b||1,0===_.size(a))return 0;var c=_.keys(a);return c.push(0),_.max(_.map(c,parseFloat),function(a){return a*b})},i=function(b){var c,d,e=1;return b.id==a.id&&(d=_.countBy(b.ideas,function(a,b){return 0>b}),(d["true"]||0)<d["false"]&&(e=-1)),c=h(b.ideas,e)+e},j=function(a,b){var c;return a.ideas=a.ideas||{},c=i(a),a.ideas[c]=b,c},k=function(b){return a.id==b?a:a.findSubIdeaById(b)},l=function(a,b){return _(_.map(_.keys(a.ideas),parseFloat)).reject(function(a){return 0>a*b})},m=function(a){return 0>a?-1:1},n={},o={},p=!1,q={},r=function(b,c,d){d?a.dispatchEvent("changed",b,c,d):a.dispatchEvent("changed",b,c)},s=function(b,c,d,e){var f;return"batch"!==b&&!q[e]&&n&&n[e]&&0!==n[e].length?(f=n[e].pop(),"batch"===f.eventMethod?n[e].push({eventMethod:"batch",eventArgs:f.eventArgs.concat([[b].concat(c)]),undoFunction:function(){d(),f.undoFunction()}}):n[e].push({eventMethod:"batch",eventArgs:[[f.eventMethod].concat(f.eventArgs)].concat([[b].concat(c)]),undoFunction:function(){d(),f.undoFunction()}}),void(p?a.dispatchEvent("changed","redo",void 0,e):(r(b,c,e),o[e]=[]))):void t(b,c,d,e)},t=function(b,c,d,e){var f={eventMethod:b,eventArgs:c,undoFunction:d};return q[e]?void q[e].push(f):(n[e]||(n[e]=[]),n[e].push(f),void(p?a.dispatchEvent("changed","redo",void 0,e):(r(b,c,e),o[e]=[])))},u=function(a,b,c){a.ideas[b]=a.ideas[c],delete a.ideas[c]},v=function(a){if(a.style){a.attr={};var b=a.style.collapsed;delete a.style.collapsed,a.attr.style=a.style,b&&(a.attr.collapsed=b),delete a.style}a.ideas&&_.each(a.ideas,v)},w=function(a){var b=String(a).indexOf(".");return b>0&&a.substr(b+1)},x={},y={},z="/xxxxxxxx-yxxx-yxxx-yxxx-xxxxxxxxxxxx/".replace(/[xy]/g,function(a){var b=16*Math.random()|0,c="x"===a?b:3&b|8;return c.toString(16)})+(b||""),A=function(a,b,c){var d;if(!a)return!1;if(d=_.extend({},a.attr),a.attr=_.extend({},a.attr),!c||"false"===c||_.isObject(c)&&_.isEmpty(c)){if(!a.attr[b])return!1;delete a.attr[b]}else{if(_.isEqual(a.attr[b],c))return!1;a.attr[b]=JSON.parse(JSON.stringify(c))}return 0===_.size(a.attr)&&delete a.attr,function(){a.attr=d}};return a.setConfiguration=function(a){y=a||{}},a.getSessionKey=function(){return b},a.nextSiblingId=function(b){var c,d,e,f=a.findParent(b);return f?(c=f.findChildRankById(b),d=l(f,c),e=_.reject(d,function(a){return Math.abs(a)<=Math.abs(c)}),0===e.length?!1:f.ideas[_.min(e,Math.abs)].id):!1},a.sameSideSiblingIds=function(b){var c=a.findParent(b),d=c.findChildRankById(b);return _.without(_.map(_.pick(c.ideas,l(c,d)),function(a){return a.id}),b)},a.getAttrById=function(a,b){var c=k(a);return c&&c.getAttr(b)},a.previousSiblingId=function(b){var c,d,e,f=a.findParent(b);return f?(c=f.findChildRankById(b),d=l(f,c),e=_.reject(d,function(a){return Math.abs(a)>=Math.abs(c)}),0===e.length?!1:f.ideas[_.max(e,Math.abs)].id):!1},a.clone=function(b){var c=b&&b!=a.id&&a.findSubIdeaById(b)||a;return JSON.parse(JSON.stringify(c))},a.cloneMultiple=function(b){return _.map(b,a.clone)},a.calculatePath=function(b,c,d){return a.id==b?[]:(c=c||[a],d=d||a,d.containsDirectChild(b)?c:_.reduce(d.ideas,function(d,e){return d||a.calculatePath(b,[e].concat(c),e)},!1))},a.getSubTreeIds=function(b){var c=[],d=function(a){return _.isEmpty(a.ideas)?[]:void _.each(a.sortedSubIdeas(),function(a){d(a),c.push(a.id)})};return d(a.findSubIdeaById(b)||a),c},a.findParent=function(b,c){return c=c||a,c.containsDirectChild(b)?c:_.reduce(c.ideas,function(c,d){return c||a.findParent(b,d)},!1)},a.startBatch=function(c){var d=c||b;a.endBatch(c),q[d]=[]},a.endBatch=function(a){var c,d,e,f=a||b,g=q[f];q[f]=void 0,_.isEmpty(g)||(1===_.size(g)?t(g[0].eventMethod,g[0].eventArgs,g[0].undoFunction,f):(c=_.map(g,function(a){return[a.eventMethod].concat(a.eventArgs)}),d=_.sortBy(_.map(g,function(a){return a.undoFunction}),function(a,b){return-1*b}),e=function(){_.each(d,function(a){a()})},t("batch",c,e,f)))},a.execCommand=function(c,d,e){return x[c]?x[c].apply(a,[e||b].concat(_.toArray(d))):!1},a.batch=function(b){a.startBatch();try{b()}finally{a.endBatch()}},x.batch=function(b){a.startBatch(b);try{_.each(_.toArray(arguments).slice(1),function(c){a.execCommand(c[0],c.slice(1),b)})}finally{a.endBatch(b)}},a.pasteMultiple=function(b,c){a.startBatch();var d=_.map(c,function(c){return a.paste(b,c)});return a.endBatch(),d},a.paste=function(b,c,d){return a.execCommand("paste",arguments)},x.paste=function(b,e,f,h){var i,k,l=e==a.id?a:a.findSubIdeaById(e),m=function(a){var b,c,d=_.omit(a,"ideas","id","attr"),e=1;return d.attr=_.omit(a.attr,y.nonClonedAttributes),_.isEmpty(d.attr)&&delete d.attr,a.ideas&&(b=_.groupBy(_.map(_.keys(a.ideas),parseFloat),function(a){return a>0}),c=_.sortBy(b[!0],Math.abs).concat(_.sortBy(b[!1],Math.abs)),d.ideas={},_.each(c,function(b){d.ideas[e++]=m(a.ideas[b])})),d};return h&&(c=parseInt(h,10)-1),i=f&&(f.title||f.attr)&&g(m(f),w(h)),l&&i?(k=j(l,i),h&&d(),A(i,"position"),t("paste",[e,f,i.id],function(){delete l.ideas[k]},b),i.id):!1},a.flip=function(b){return a.execCommand("flip",arguments)},x.flip=function(b,c){var d,e,f=a.findChildRankById(c);return f?(e=h(a.ideas,-1*m(f)),d=e-10*m(f),u(a,d,f),t("flip",[c],function(){u(a,f,d)},b),!0):!1},a.initialiseTitle=function(b,c){return a.execCommand("initialiseTitle",arguments)},x.initialiseTitle=function(a,b,c){var d,e=k(b);return e?(d=e.title,d==c?!1:(e.title=c,s("initialiseTitle",[b,c],function(){e.title=d},a),!0)):!1},a.updateTitle=function(b,c){return a.execCommand("updateTitle",arguments)},x.updateTitle=function(a,b,c){var d,e=k(b);return e?(d=e.title,d==c?!1:(e.title=c,t("updateTitle",[b,c],function(){e.title=d},a),!0)):!1},a.addSubIdea=function(b,c,d){return a.execCommand("addSubIdea",arguments)},x.addSubIdea=function(a,b,c,d){var e,f,h=k(b);return h?d&&k(d)?!1:(e=g({title:c,id:d}),f=j(h,e),t("addSubIdea",[b,c,e.id],function(){delete h.ideas[f]},a),e.id):!1},a.removeMultiple=function(b){a.startBatch();var c=_.map(b,a.removeSubIdea);return a.endBatch(),c},a.removeSubIdea=function(b){return a.execCommand("removeSubIdea",arguments)},x.removeSubIdea=function(b,c){var d,e,f,g=a.findParent(c);return g?(d=g.findChildRankById(c),e=g.ideas[d],delete g.ideas[d],f=a.links,a.links=_.reject(a.links,function(a){return a.ideaIdFrom==c||a.ideaIdTo==c}),t("removeSubIdea",[c],function(){g.ideas[d]=e,a.links=f},b),!0):!1},a.insertIntermediateMultiple=function(b){a.startBatch();var c=a.insertIntermediate(b[0]);return _.each(b.slice(1),function(b){a.changeParent(b,c)}),a.endBatch(),c},a.insertIntermediate=function(b,c,d){return a.execCommand("insertIntermediate",arguments)},x.insertIntermediate=function(b,c,d,e){if(a.id==c)return!1;var f,h,i,j=a.findParent(c);return j?e&&k(e)?!1:(f=j.findChildRankById(c))?(h=j.ideas[f],i=g({title:d,id:e}),j.ideas[f]=i,i.ideas={1:h},t("insertIntermediate",[c,d,i.id],function(){j.ideas[f]=h},b),i.id):!1:!1},a.changeParent=function(b,c){return a.execCommand("changeParent",arguments)},x.changeParent=function(b,c,d){var e,f,g,h,i,l=k(d);return c==d?!1:l&&(h=a.findSubIdeaById(c))?h.findSubIdeaById(d)?!1:l.containsDirectChild(c)?!1:(e=a.findParent(c))?(f=e.findChildRankById(c),g=j(l,h),i=h.getAttr("position"),A(h,"position"),delete e.ideas[f],t("changeParent",[c,d],function(){A(h,"position",i),e.ideas[f]=h,delete l.ideas[g]},b),!0):!1:!1},a.mergeAttrProperty=function(b,c,d,e){var f=a.getAttrById(b,c)||{};return e?f[d]=e:delete f[d],_.isEmpty(f)&&(f=!1),a.updateAttr(b,c,f)},a.updateAttr=function(b,c,d){return a.execCommand("updateAttr",arguments)},x.updateAttr=function(a,b,c,d){var e,f=k(b);return e=A(f,c,d),e&&t("updateAttr",[b,c,d],e,a),!!e},a.moveRelative=function(b,c){var d=a.findParent(b),e=d&&d.findChildRankById(b),f=e&&_.sortBy(l(d,e),Math.abs),g=f&&f.indexOf(e),h=g+(c>0?c+1:c),i=h>=0&&d&&f&&d.ideas[f[h]];return 0>h||!d?!1:a.positionBefore(b,i&&i.id,d)},a.positionBefore=function(b,c,d){return a.execCommand("positionBefore",arguments)},x.positionBefore=function(b,c,d,e){e=e||a;var f,g,i,j,k,m,n;if(n=e.findChildRankById(c),!n)return _.reduce(e.ideas,function(a,e){return a||x.positionBefore(b,c,d,e)},!1);if(c==d)return!1;if(f=0,d){if(g=e.findChildRankById(d),!g)return!1;if(i=l(e,n),j=_.reject(_.sortBy(i,Math.abs),function(a){return Math.abs(a)>=Math.abs(g)}),k=j.length>0?_.max(j,Math.abs):0,k==n)return!1;f=k+(g-k)/2}else{if(m=h(e.ideas,0>n?-1:1),m==n)return!1;f=m+10*(0>n?-1:1)}return f==n?!1:(u(e,f,n),t("positionBefore",[c,d],function(){u(e,n,f)},b),!0)},observable(a),function(){var b=function(a,b){var c,d,e;return a===b?!1:(d=k(a))&&(e=k(b))?(c=_.find(d.ideas,function(a){return a.id===b})||_.find(e.ideas,function(b){return b.id===a}),!c):!1};a.addLink=function(b,c){return a.execCommand("addLink",arguments)},x.addLink=function(c,d,e){var f,g;return b(d,e)?(f=_.find(a.links,function(a){return a.ideaIdFrom===d&&a.ideaIdTo===e||a.ideaIdFrom===e&&a.ideaIdTo===d}))?!1:(a.links=a.links||[],g={ideaIdFrom:d,ideaIdTo:e,attr:{style:{color:"#FF0000",lineStyle:"dashed"}}},a.links.push(g),t("addLink",[d,e],function(){a.links.pop()},c),!0):!1},a.removeLink=function(b,c){return a.execCommand("removeLink",arguments)},x.removeLink=function(b,c,d){for(var e,f=0;a.links&&f<a.links.length;){if(e=a.links[f],String(e.ideaIdFrom)===String(c)&&String(e.ideaIdTo)===String(d))return a.links.splice(f,1),t("removeLink",[c,d],function(){a.links.push(_.clone(e))},b),!0;f+=1}return!1},a.getLinkAttr=function(b,c,d){var e=_.find(a.links,function(a){return a.ideaIdFrom==b&&a.ideaIdTo==c});return e&&e.attr&&e.attr[d]?e.attr[d]:!1},a.updateLinkAttr=function(b,c,d,e){return a.execCommand("updateLinkAttr",arguments)},x.updateLinkAttr=function(b,c,d,e,f){var g,h=_.find(a.links,function(a){return a.ideaIdFrom==c&&a.ideaIdTo==d});return g=A(h,e,f),g&&t("updateLinkAttr",[c,d,e,f],g,b),!!g}}(),a.canUndo=function(){return!!(n[b]&&n[b].length>0)},a.canRedo=function(){return!!(o[b]&&o[b].length>0)},a.undo=function(){return a.execCommand("undo",arguments)},x.undo=function(b){a.endBatch();var c;return c=n[b]&&n[b].pop(),c&&c.undoFunction?(c.undoFunction(),o[b]||(o[b]=[]),o[b].push(c),a.dispatchEvent("changed","undo",[],b),!0):!1},a.redo=function(){return a.execCommand("redo",arguments)},x.redo=function(b){a.endBatch();var c;return c=o[b]&&o[b].pop(),c?(p=!0,a.execCommand(c.eventMethod,c.eventArgs,b),p=!1,!0):!1},a.storeResource=function(){return a.execCommand("storeResource",arguments)},x.storeResource=function(c,d,e){var f,g,h=function(){if(_.isEmpty(a.resources))return 0;var c=function(a){return parseInt(a,10)},d=_.keys(a.resources),e=b?_.filter(d,RegExp.prototype.test.bind(new RegExp("\\/"+b+"$"))):d,f=_.map(e,c);return _.isEmpty(f)?0:_.max(f)},i=function(){var a=h()+1;return a+z};return!e&&a.resources&&(f=_.find(_.keys(a.resources),function(b){return a.resources[b]===d}))?f:(g=e||i(),a.resources=a.resources||{},a.resources[g]=d,a.dispatchEvent("resourceStored",d,g,c),g)},a.getResource=function(b){return a.resources&&a.resources[b]},a.hasSiblings=function(b){if(b===a.id)return!1;var c=a.findParent(b);return c&&_.size(c.ideas)>1},2!=a.formatVersion&&(v(a),a.formatVersion=2),g(a),a},MAPJS.MemoryClipboard=function(){"use strict";var a,b=this,c=function(a){return a?JSON.parse(JSON.stringify(a)):void 0};b.get=function(){return c(a)},b.put=function(b){a=c(b)}},function(){"use strict";$.fn.simpleDraggableContainer=function(){var a,b,c=this,d=function(c){if(a&&c.gesture){var d={top:Math.round(parseInt(b.top,10)+c.gesture.deltaY),left:Math.round(parseInt(b.left,10)+c.gesture.deltaX)};return a.css(d).trigger($.Event("mm:drag",{currentPosition:d,gesture:c.gesture})),c.gesture&&c.gesture.preventDefault(),!1}},e=function(c){var d=a;"shadow"!==d.attr("mapjs-drag-role")?d.animate(b,{complete:function(){d.trigger($.Event("mm:cancel-dragging",{gesture:c.gesture}))},progress:function(){d.trigger("mm:drag")}}):d.trigger($.Event("mm:cancel-dragging",{gesture:c.gesture}))};return Hammer(this,{drag_min_distance:2}),this.on("mm:start-dragging",function(c){a||(a=$(c.relatedTarget),b={top:a.css("top"),left:a.css("left")},$(this).on("drag",d))}).on("mm:start-dragging-shadow",function(e){var f=$(e.relatedTarget),g=function(){var a=f.clone().addClass("drag-shadow").appendTo(c).offset(f.offset()).data(f.data()).attr("mapjs-drag-role","shadow"),b=f.parent().data("scale")||1;return 0!==b&&a.css({transform:"scale("+b+")","transform-origin":"top left"}),a};a||(a=g(),b={top:a.css("top"),left:a.css("left")},a.on("mm:stop-dragging mm:cancel-dragging",function(a){this.remove(),a.stopPropagation(),a.stopImmediatePropagation();var b=$.Event(a.type,{gesture:a.gesture,finalPosition:a.finalPosition});f.trigger(b)}).on("mm:drag",function(a){f.trigger(a)}),$(this).on("drag",d))}).on("dragend",function(b){if($(this).off("drag",d),a){var c=$.Event("mm:stop-dragging",{gesture:b.gesture,finalPosition:a.offset()});a.trigger(c),c.result===!1&&e(b),a=void 0}}).on("mouseleave",function(b){a&&($(this).off("drag",d),e(b),a=void 0)}).attr("data-drag-role","container")};var a=function(a){$(this).trigger($.Event("mm:start-dragging",{relatedTarget:this,gesture:a.gesture})),a.stopPropagation(),a.preventDefault(),a.gesture&&(a.gesture.stopPropagation(),a.gesture.preventDefault())},b=function(a){$(this).trigger($.Event("mm:start-dragging-shadow",{relatedTarget:this,gesture:a.gesture})),a.stopPropagation(),a.preventDefault(),a.gesture&&(a.gesture.stopPropagation(),a.gesture.preventDefault())};$.fn.simpleDraggable=function(b){return b&&b.disable?$(this).off("dragstart",a):$(this).on("dragstart",a)},$.fn.shadowDraggable=function(a){return a&&a.disable?$(this).off("dragstart",b):$(this).on("dragstart",b)}}(),MAPJS.MapModel=function(a,b,c,d,e){"use strict";var f,g,h,i,j,k,l,m=this,n=a,o=d||20,p=c||new MAPJS.MemoryClipboard,q=!0,r=!0,s=[],t=function(a){var b=_.clone(s);s=0===a.length?[i]:a,m.dispatchEvent("activatedNodesChanged",_.difference(s,b),_.difference(b,s))},u=function(a){var b;h&&(b=h(g),_.each(a.nodes,function(a,c){(b[c]||0===b[c])&&(a.label=b[c])}))},v=function(a,b){var c,d=D.getLayout(),e=d.theme!=a.theme;m.dispatchEvent("layoutChangeStarting",_.size(a.nodes)-_.size(d.nodes)),u(a),_.each(d.connectors,function(b,c){var d=a.connectors[c];d&&d.from===b.from&&d.to===b.to||m.dispatchEvent("connectorRemoved",b)}),_.each(d.links,function(b,c){var d=a.links&&a.links[c];d||m.dispatchEvent("linkRemoved",b)}),_.each(d.nodes,function(c,d){var e,f=a.nodes[d];f||(d==i&&m.selectNode(g.id),e=_.reject(s,function(a){return a==d}),e.length!==s.length&&t(e),m.dispatchEvent("nodeRemoved",c,d,b))}),_.each(a.nodes,function(a,c){var f=d.nodes[c];f?(a.x===f.x&&a.y===f.y&&a.width===f.width&&a.height===f.height||m.dispatchEvent("nodeMoved",a,b),a.title!==f.title&&m.dispatchEvent("nodeTitleChanged",a,b),_.isEqual(a.attr||{},f.attr||{})||m.dispatchEvent("nodeAttrChanged",a,b),(a.level!==f.level||e)&&m.dispatchEvent("nodeAttrChanged",a,b),a.label!==f.label&&m.dispatchEvent("nodeLabelChanged",a,b)):m.dispatchEvent("nodeCreated",a,b)}),_.each(a.connectors,function(a,c){var e=d.connectors[c];e&&a.from===e.from&&a.to===e.to||m.dispatchEvent("connectorCreated",a,b)}),_.each(a.links,function(a,c){var e=d.links&&d.links[c];e?_.isEqual(a.attr||{},e&&e.attr||{})||m.dispatchEvent("linkAttrChanged",a,b):m.dispatchEvent("linkCreated",a,b)}),e&&(c={themeChanged:!0}),D.setLayout(a),m.isInCollapse||m.dispatchEvent("layoutChangeComplete",c)},w=function(a){k=i,l=s.slice(0),m.selectNode(a)},x=function(a){w(a),m.editNode(!1,!0,!0)},y=function(){return i||g.id},z=!1,A=function(a,b,c){z||(k=!1,l=!1,m.rebuildRequired(c))},B=function(){return g.findSubIdeaById(i)||g},C=function(a,b){var c=g.findSubIdeaById(b)||g;c.getAttr("collapsed")&&g.updateAttr(b,"collapsed",!1)},D=e&&e.layoutModel||new MAPJS.LayoutModel({nodes:{},connectors:{}});observable(this),f=m.dispatchEvent.bind(m,"analytic","mapModel"),m.pause=function(){z=!0},m.resume=function(){z=!1,m.rebuildRequired()},m.getIdea=function(){return g},m.isEditingEnabled=function(){return r},m.getCurrentLayout=function(){return D.getLayout()},m.analytic=f,m.getCurrentlySelectedIdeaId=y,m.rebuildRequired=function(a){g&&(D.getLayout().theme!==(g.attr&&g.attr.theme)&&m.dispatchEvent("themeChanged",g.attr&&g.attr.theme),v(m.reactivate(n(g)),a))},this.setIdea=function(a){g&&(g.removeEventListener("changed",A),z=!1,t([]),m.dispatchEvent("nodeSelectionChanged",i,!1),i=void 0),g=a,g.addEventListener("changed",A),A(),m.selectNode(g.id,!0),m.dispatchEvent("mapViewResetRequested")},this.setEditingEnabled=function(a){r=a},this.getEditingEnabled=function(){return r},this.setInputEnabled=function(a,b){q!==a&&(q=a,m.dispatchEvent("inputEnabledChanged",a,!!b))},this.getInputEnabled=function(){return q},this.selectNode=function(a,b,c){(b||q&&(a!==i||!m.isActivated(a)))&&(i&&m.dispatchEvent("nodeSelectionChanged",i,!1),i=a,c?m.activateNode("internal",a):t([a]),m.dispatchEvent("nodeSelectionChanged",a,!0))},this.clickNode=function(a,b){var c=b&&b.button&&-1!==b.button;b&&b.altKey?m.toggleLink("mouse",a):b&&b.shiftKey?m.toggleActivationOnNode("mouse",a):j&&!c?(this.toggleLink("mouse",a),this.toggleAddLinkMode()):(this.selectNode(a),c&&-1!==c&&q&&m.dispatchEvent("contextMenuRequested",a,b.layerX,b.layerY))},this.findIdeaById=function(a){return g.id==a?g:g.findSubIdeaById(a)},this.getSelectedStyle=function(a){return this.getStyleForId(i,a)},this.getStyleForId=function(a,b){var c=D.getNode(a);return c&&c.attr&&c.attr.style&&c.attr.style[b]},this.toggleCollapse=function(a){var b,c=B();b=m.isActivated(c.id)&&_.size(c.ideas)>0?c.getAttr("collapsed"):m.everyActivatedIs(function(a){var b=m.findIdeaById(a);return b&&_.size(b.ideas)>0?b.getAttr("collapsed"):!0}),this.collapse(a,!b)},this.collapse=function(a,b){var c,d,e=y(),h=function(){return D.getNode(e)},i=function(a,b,c){(b||c)&&_.each(a,function(a){a.x+=b,a.y+=c,m.dispatchEvent("nodeMoved",a,"scroll")})};f("collapse:"+b,a),m.isInCollapse=!0,c=h(),q&&m.applyToActivated(function(a){var c=m.findIdeaById(a);c&&(!b||c.ideas&&_.size(c.ideas)>0)&&g.updateAttr(a,"collapsed",b)}),d=h(),c&&d&&i(D.getLayout().nodes,c.x-d.x,c.y-d.y),m.isInCollapse=!1,m.dispatchEvent("layoutChangeComplete")},this.updateStyle=function(a,b,c){return r?void(q&&(f("updateStyle:"+b,a),m.applyToActivated(function(a){m.getStyleForId(a,b)!=c&&g.mergeAttrProperty(a,"style",b,c)}))):!1},this.updateLinkStyle=function(a,b,c,d,e){var h=_.extend({},g.getLinkAttr(b,c,"style"));return r?void(q&&(f("updateLinkStyle:"+d,a),h[d]=e,g.updateLinkAttr(b,c,"style",h))):!1},this.addSubIdea=function(a,b,c){var d,e=b||i;return r?(f("addSubIdea",a),void(q&&(g.batch(function(){C(a,e),d=c?g.addSubIdea(e,c):g.addSubIdea(e)}),d&&(c?w(d):x(d))))):!1},this.insertIntermediate=function(a){var b,c=[];return r&&q&&i!==g.id?(f("insertIntermediate",a),m.applyToActivated(function(a){c.push(a)}),b=g.insertIntermediateMultiple(c),void(b&&x(b))):!1},this.flip=function(a){var b=D.getNode(i);return r?(f("flip",a),q&&i!==g.id&&b&&2===b.level?g.flip(i):!1):!1},this.addSiblingIdeaBefore=function(a){var b,c,d,e;return r?(f("addSiblingIdeaBefore",a),q?(c=g.findParent(i)||g,g.batch(function(){C(a,c.id),b=g.addSubIdea(c.id),b&&i!==g.id&&(d=c.findChildRankById(i),e=c.findChildRankById(b),0>d*e&&g.flip(b),g.positionBefore(b,i))}),void(b&&x(b))):!1):!1},this.addSiblingIdea=function(a,b,c){var d,e,h,j,k,l;return l=b||i,r?(f("addSiblingIdea",a),void(q&&(h=g.findParent(l)||g,g.batch(function(){C(a,h.id),d=c?g.addSubIdea(h.id,c):g.addSubIdea(h.id),d&&l!==g.id&&(e=g.nextSiblingId(l),j=h.findChildRankById(l),k=h.findChildRankById(d),0>j*k&&g.flip(d),e&&g.positionBefore(d,e))}),d&&(c?w(d):x(d))))):!1},this.removeSubIdea=function(a){var b;return r?(f("removeSubIdea",a),q&&m.applyToActivated(function(a){var c;i==a&&(c=g.findParent(i),c&&m.selectNode(c.id)),b=g.removeSubIdea(a)}),b):!1},this.updateTitle=function(a,b,c){c?g.initialiseTitle(a,b):g.updateTitle(a,b)},this.editNode=function(a,c,d){var e;return r?(a&&f("editNode",a),q?(e=B().title,_.include(b,e)&&(c=!0),void m.dispatchEvent("nodeEditRequested",i,c,!!d)):!1):!1},this.editIcon=function(a){return r?(a&&f("editIcon",a),q?void m.dispatchEvent("nodeIconEditRequested",i):!1):!1},this.scaleUp=function(a){m.scale(a,1.25)},this.scaleDown=function(a){m.scale(a,.8)},this.scale=function(a,b,c){q&&(m.dispatchEvent("mapScaleChanged",b,c),f(1>b?"scaleDown":"scaleUp",a))},this.move=function(a,b,c){q&&(m.dispatchEvent("mapMoveRequested",b,c),f("move",a))},this.resetView=function(a){q&&(m.selectNode(g.id),m.dispatchEvent("mapViewResetRequested"),f("resetView",a))},this.decorationAction=function(a,b,c){f("decorationAction",a),m.dispatchEvent("decorationActionRequested",b,c)},this.openAttachment=function(a,b){var c,d;f("openAttachment",a),b=b||i,c=D.getNode(b),d=c&&c.attr&&c.attr.attachment,c&&m.dispatchEvent("attachmentOpened",b,d)},this.setAttachment=function(a,b,c){var d=!(!c||!c.content);return r?(f("setAttachment",a),void g.updateAttr(b,"attachment",d&&c)):!1},this.toggleLink=function(a,b){var c=_.find(g.links,function(a){return String(a.ideaIdFrom)===String(b)&&String(a.ideaIdTo)===String(i)||String(a.ideaIdTo)===String(b)&&String(a.ideaIdFrom)===String(i)});c?m.removeLink(a,c.ideaIdFrom,c.ideaIdTo):m.addLink(a,b)},this.addLink=function(a,b){return r?(f("addLink",a),void g.addLink(i,b)):!1},this.selectLink=function(a,b,c){return r?(f("selectLink",a),b?void m.dispatchEvent("linkSelected",b,c,g.getLinkAttr(b.ideaIdFrom,b.ideaIdTo,"style")):!1):!1},this.removeLink=function(a,b,c){return r?(f("removeLink",a),void g.removeLink(b,c)):!1},this.toggleAddLinkMode=function(a){return r&&q?(f("toggleAddLinkMode",a),j=!j,void m.dispatchEvent("addLinkModeToggled",j)):!1},this.cancelCurrentAction=function(a){return q&&r?void(j&&this.toggleAddLinkMode(a)):!1},m.undo=function(a){var b=k,c=l;return r?(f("undo",a),void(q&&(g.undo(),b&&m.selectNode(b),c&&t(c)))):!1},m.redo=function(a){return r?(f("redo",a),void(q&&g.redo())):!1},m.moveRelative=function(a,b){return r?(f("moveRelative",a),void(q&&g.moveRelative(i,b))):!1},m.cut=function(a){var b,c=[],d=[];return r?(f("cut",a),void(q&&(m.applyToActivated(function(a){c.push(a),d.push(g.findParent(a).id)}),p.put(g.cloneMultiple(c)),g.removeMultiple(c),b=_.find(d,g.findSubIdeaById),m.selectNode(b||g.id)))):!1},m.contextForNode=function(a){var b=m.findIdeaById(a),c=b&&b.ideas&&_.size(b.ideas)>0,d=g.hasSiblings(a),e=b&&b.getAttr("collapsed"),f=b&&r&&p&&p.get();return b?{hasChildren:!!c,hasSiblings:!!d,canPaste:!!f,notRoot:g.id!=a,canUndo:g.canUndo(),canRedo:g.canRedo(),canCollapse:c&&!e,canExpand:c&&e}:void 0},m.copy=function(a){var b=[];return r?(f("copy",a),void(q&&(m.applyToActivated(function(a){b.push(a)}),p.put(g.cloneMultiple(b))))):!1},m.paste=function(a){var b;return r?(f("paste",a),void(q&&(b=g.pasteMultiple(i,p.get()),b&&b[0]&&m.selectNode(b[0])))):!1},m.pasteStyle=function(a){var b,c=p.get();return r?(f("pasteStyle",a),void(q&&c&&c[0]&&(b=c[0].attr&&c[0].attr.style,m.applyToActivated(function(a){g.updateAttr(a,"style",b)})))):!1},m.getIcon=function(a){var b=D.getNode(a||i);return b?b.attr&&b.attr.icon:!1},m.setIcon=function(a,b,c,d,e,h,j){var k,l;return r?(f("setIcon",a),h=h||i,(k=m.findIdeaById(h))?void(b?(l={url:b,width:c,height:d,position:e},j&&(l.metaData=j),g.updateAttr(h,"icon",l)):k.title||h===g.id?g.updateAttr(h,"icon",!1):g.removeSubIdea(h)):!1):!1},m.insertUp=function(a){"standard"===D.getOrientation()?m.addSiblingIdeaBefore(a):m.insertIntermediate(a)},m.insertDown=function(a){"standard"===D.getOrientation()?m.addSiblingIdea(a):m.addSubIdea(a)},m.insertLeft=function(a){"standard"===D.getOrientation()?m.insertIntermediate(a):m.addSiblingIdeaBefore(a)},m.insertRight=function(a){"standard"===D.getOrientation()?m.addSubIdea(a):m.addSiblingIdea(a)},m.moveUp=function(a){"standard"===D.getOrientation()&&m.moveRelative(a,-1)},m.moveDown=function(a){"standard"===D.getOrientation()&&m.moveRelative(a,1)},m.moveLeft=function(a){"standard"===D.getOrientation()?m.flip(a):m.moveRelative(a,-1)},m.moveRight=function(a){"standard"===D.getOrientation()?m.flip(a):m.moveRelative(a,1)},m.getSelectedNodeId=function(){return y()},m.centerOnNode=function(a){D.getNode(a)||(g.startBatch(),_.each(g.calculatePath(a),function(a){g.updateAttr(a.id,"collapsed",!1)}),g.endBatch()),m.dispatchEvent("nodeFocusRequested",a),m.selectNode(a)},m.search=function(a){var b=[];return a=a.toLocaleLowerCase(),g.traverse(function(c){c.title&&c.title.toLocaleLowerCase().indexOf(a)>=0&&b.push({id:c.id,title:c.title})}),b},function(){var a=function(a,b,c,d){var e;q&&(f(b,a),e=D["nodeId"+d](i),e&&c.apply(m,[e]))},b={};["Left","Right","Up","Down"].forEach(function(c){b[c]=function(b,d,e){a(b,d,e,c)}}),m.getActivatedNodeIds=function(){return s.slice(0)},m.activateSiblingNodes=function(a){var b,c=g.findParent(i);f("activateSiblingNodes",a),c&&c.ideas&&(b=_.map(c.ideas,function(a){return a.id}),t(b))},m.activateNodeAndChildren=function(a){var b=y(),c=g.getSubTreeIds(b);f("activateNodeAndChildren",a),c.push(b),t(c)},_.each(["Left","Right","Up","Down"],function(a){m["activateNode"+a]=function(c){b[a](c,"activateNode"+a,function(a){m.selectNode(a,!1,!0)})},m["selectNode"+a]=function(c){b[a](c,"selectNode"+a,m.selectNode)}}),m.toggleActivationOnNode=function(a,b){f("toggleActivated",a),t(m.isActivated(b)?_.without(s,b):[b].concat(s))},m.activateNode=function(a,b){f("activateNode",a),m.isActivated(b)||(s.push(b),m.dispatchEvent("activatedNodesChanged",[b],[]))},m.activateChildren=function(a){var b=B();f("activateChildren",a),!b||_.isEmpty(b.ideas)||b.getAttr("collapsed")||t(g.getSubTreeIds(b.id))},m.activateSelectedNode=function(a){f("activateSelectedNode",a),t([y()])},m.isActivated=function(a){return _.find(s,function(b){return a==b})},m.applyToActivated=function(a){g.batch(function(){_.each(s,a)})},m.everyActivatedIs=function(a){return _.every(s,a)},m.activateLevel=function(a,b){var c=_.map(_.filter(D.getLayout().nodes,function(a){return a.level==b}),function(a){return a.id});f("activateLevel",a),_.isEmpty(c)||t(c)},m.reactivate=function(a){return _.each(a.nodes,function(a){_.contains(s,a.id)&&(a.activated=!0)}),a}}(),m.getNodeIdAtPosition=function(a,b){var c=function(c){return a>=c.x&&b>=c.y&&a<=c.x+c.width&&b<=c.y+c.height},d=_.find(D.getLayout().nodes,c);return d&&d.id},m.autoPosition=function(a){return g.updateAttr(a,"position",!1)},m.standardPositionNodeAt=function(a,b,c,d){var e,h=D.getNode(g.id),i={id:null,y:1/0},j=g.findParent(a),k=D.getNode(j.id),l=D.getNode(a),n=D.getNode(a),o=function(b,c,d){var e=b.x<c.x&&d<b.x,f=b.x>c.x&&b.x<d;return e||f?g.flip(a):!1},p=1,q=function(){return 2===n.level||(n.x-k.x)*(b-k.x)>0},r=!1;return g.startBatch(),l&&2===l.level&&(r=o(h,n,b)),_.each(g.sameSideSiblingIds(a),function(a){var b=D.getNode(a);c<b.y&&b.y<i.y&&(i=b)}),!d&&q()&&m.autoPosition(a),r=g.positionBefore(a,i.id)||r,d&&q()&&(e=b<k.x?k.x-b-n.width+k.width:b-k.x,f("nodeManuallyPositioned"),p=_.max(_.map(j.ideas,function(b){return b.id!==a&&b.attr&&b.attr.position&&b.attr.position[2]||0})),r=g.updateAttr(a,"position",[e,c-k.y,p+1])||r),g.endBatch(),r},m.topDownPositionNodeAt=function(a,b,c,d){var e,f,h=g.findParent(a);return h?d?!1:(_.each(h.ideas,function(c){var d=D.getNode(c.id);c.id!==a&&b<d.x&&(!f||Math.abs(b-d.x)<Math.abs(b-f.x))&&(f=c)}),g.batch(function(){m.autoPosition(a),e=g.positionBefore(a,f&&f.id)}),e):!1},m.positionNodeAt=function(a,b,c,d){return"standard"===D.getOrientation()?m.standardPositionNodeAt(a,b,c,d):m.topDownPositionNodeAt(a,b,c,d)},m.dropNode=function(a,b,c){var d,e=g.findParent(a);return b===a?!1:c?(d=g.clone(a),d&&g.paste(b,d),!1):b===e.id?m.autoPosition(a):g.changeParent(a,b)},m.setLayoutCalculator=function(a){n=a},m.dropImage=function(a,b,c,d,e,f){var h,j=function(d,e){var h=Math.min(b,300)/b,i=Math.min(c,300)/c,j=Math.min(h,i),k=g.getAttrById(d,"icon");m.setIcon("drag and drop",a,Math.round(b*j),Math.round(c*j),k&&k.position||e,d,f)},k=function(){var a;g.startBatch(),a=g.addSubIdea(i),j(a,"center"),g.endBatch(),m.selectNode(a)};return(h=m.getNodeIdAtPosition(d,e))?j(h,"left"):void k()},m.setLabelGenerator=function(a){h=a,m.rebuildRequired()},m.getStandardReorderBoundary=function(a){var b,c,d,e,f,h,i=D.getNode(a),j=D.getNode(g.id),k=function(){return a==g.id},l=function(){return b.id===g.id},m=function(){return i&&j&&i.x>=j.x},n=function(a,b){var d=_.map(a,function(a){return a.y}),e=_.map(a,function(a){return a.y+a.height}),f={minY:_.min(d)-o-i.height,maxY:_.max(e)+o,margin:o};return f.edge=b,"left"===b?f.x=c.x+c.width+o:f.x=c.x-o,f},p=function(a){var b={minY:c.y-o-i.height,maxY:c.y+c.height+o,margin:o};return b.edge=a,"left"===a?b.x=c.x+c.width+o:b.x=c.x-o,b},q=function(){var a=_.map(b.ideas,function(a){return D.getNode(a.id)});return a=_.without(a,i),_.isEmpty(d)||(a=_.difference(a,d)),a},r=[];return k(a)?!1:(b=g.findParent(a),c=D.getNode(b.id),f=m(a)?"left":"right",h=m(a)?"right":"left",d=_.map(g.sameSideSiblingIds(a),function(a){return D.getNode(a)}),_.isEmpty(d)||r.push(n(d,f)),r.push(p(f)),l()&&(e=q(),_.isEmpty(e)||r.push(n(e,h)),r.push(p(h))),r)},m.getTopDownReorderBoundary=function(a){var b=D.getNode(a),c=g.findParent(a),d=1/0,e=-(1/0),f=-(1/0),h=10;return c?(_.each(c.ideas,function(b){var c=D.getNode(b.id);b.id!==a&&(d=Math.min(c.x,d),e=Math.max(c.x+c.width,e),f=Math.max(c.y+c.height,f))}),[{minY:b.y-b.height-h,maxY:f+h,minX:d-b.width-h,maxX:e+h,edge:"top"}]):[]},m.getReorderBoundary=function(a){return"standard"===D.getOrientation()?m.getStandardReorderBoundary(a):m.getTopDownReorderBoundary(a)},m.focusAndSelect=function(a){m.selectNode(a),m.dispatchEvent("nodeFocusRequested",a)},m.requestContextMenu=function(a,b){return q&&r?(m.dispatchEvent("contextMenuRequested",i,a,b),!0):!1},m.setTheme=function(a){return r?void g.updateAttr(g.id,"theme",a):!1}},jQuery.fn.mapToolbarWidget=function(a){"use strict";var b=["insertIntermediate","scaleUp","scaleDown","addSubIdea","editNode","removeSubIdea","toggleCollapse","addSiblingIdea","undo","redo","copy","cut","paste","resetView","openAttachment","toggleAddLinkMode","activateChildren","activateNodeAndChildren","activateSiblingNodes","editIcon"],c=["updateStyle"];
return this.each(function(){var d=jQuery(this),e=!1;a.addEventListener("nodeSelectionChanged",function(){e=!0,d.find(".updateStyle[data-mm-target-property]").val(function(){return a.getSelectedStyle(jQuery(this).data("mm-target-property"))}).change(),e=!1}),a.addEventListener("addLinkModeToggled",function(){d.find(".toggleAddLinkMode").toggleClass("active")}),b.forEach(function(b){d.find("."+b).click(function(){a[b]&&a[b]("toolbar")})}),c.forEach(function(b){d.find("."+b).change(function(){if(!e){var c=jQuery(this);c.data("mm-target-property")&&a[b]("toolbar",c.data("mm-target-property"),c.val())}})})})},jQuery.fn.linkEditWidget=function(a){"use strict";return this.each(function(){var b,c,d,e,f,g,h=jQuery(this);e=h.find(".color"),f=h.find(".lineStyle"),g=h.find(".arrow"),a.addEventListener("linkSelected",function(a,i,j){b=a,h.show(),c=c||h.width(),d=d||h.height(),h.css({top:i.y-.5*d-15+"px",left:i.x-.5*c-15+"px"}),e.val(j.color).change(),f.val(j.lineStyle),g[j.arrow?"addClass":"removeClass"]("active")}),a.addEventListener("mapMoveRequested",function(){h.hide()}),h.find(".delete").click(function(){a.removeLink("mouse",b.ideaIdFrom,b.ideaIdTo),h.hide()}),e.change(function(){a.updateLinkStyle("mouse",b.ideaIdFrom,b.ideaIdTo,"color",jQuery(this).val())}),f.find("a").click(function(){a.updateLinkStyle("mouse",b.ideaIdFrom,b.ideaIdTo,"lineStyle",jQuery(this).text())}),g.click(function(){a.updateLinkStyle("mouse",b.ideaIdFrom,b.ideaIdTo,"arrow",!g.hasClass("active"))}),h.mouseleave(h.hide.bind(h))})},MAPJS.getDataURIAndDimensions=function(a,b){"use strict";var c=function(a){return/^data:image/.test(a)},d=function(a){if(c(a.src))return a.src;var b,d=document.createElement("canvas");return d.width=a.width,d.height=a.height,b=d.getContext("2d"),b.drawImage(a,0,0),d.toDataURL("image/png")},e=jQuery.Deferred(),f=new Image;return f.onload=function(){try{e.resolve({dataUri:d(f),width:f.width,height:f.height})}catch(a){e.reject()}},f.onerror=function(){e.reject()},c(a)||(b?(f.crossOrigin="Anonymous",a=b+encodeURIComponent(a)):e.reject("no-cors")),f.src=a,e.promise()},MAPJS.ImageInsertController=function(a,b){"use strict";var c=observable(this),d=function(a){var b=jQuery.Deferred(),c=new FileReader;return c.onload=function(a){b.resolve(a.target.result)},c.onerror=b.reject,c.onprogress=b.notify,c.readAsDataURL(a),b.promise()};c.insertDataUrl=function(d,e){c.dispatchEvent("imageLoadStarted"),MAPJS.getDataURIAndDimensions(d,a).then(function(a){var d=a.dataUri;b&&(d=b(d)),c.dispatchEvent("imageInserted",d,a.width,a.height,e)},function(a){c.dispatchEvent("imageInsertError",a)})},c.insertFiles=function(a,b){jQuery.each(a,function(a,e){/^image\//.test(e.type)&&jQuery.when(d(e)).done(function(a){c.insertDataUrl(a,b)})})},c.insertHtmlContent=function(a,b){var d=a.match(/img[^>]*src="([^"]*)"/);d&&d.length>0&&_.each(d.slice(1),function(a){c.insertDataUrl(a,b)})}},jQuery.fn.imageDropWidget=function(a){"use strict";return this.on("dragenter dragover",function(a){return a.originalEvent.dataTransfer?!1:void 0}).on("drop",function(b){var c,d=b.originalEvent.dataTransfer;b.stopPropagation(),b.preventDefault(),d&&d.files&&d.files.length>0?a.insertFiles(d.files,b.originalEvent):d&&(c=d.getData("text/html"),a.insertHtmlContent(c,b.originalEvent))}),this},MAPJS.DOMRender={svgPixel:'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="1" height="1"></svg>',nodeCacheMark:function(a,b){"use strict";return{title:a.title,theme:MAPJS.DOMRender.theme&&MAPJS.DOMRender.theme.name,icon:a.attr&&a.attr.icon&&_.pick(a.attr.icon,"width","height","position"),collapsed:a.attr&&a.attr.collapsed,note:!(!a.attr||!a.attr.note),level:a.level||b}},dummyTextBox:jQuery("<div>").addClass("mapjs-node").css({position:"absolute",visibility:"hidden"}),dimensionProvider:function(a,b){"use strict";var c,d=jQuery(document).nodeWithId(a.id),e=function(){return MAPJS.DOMRender.svgPixel};return d&&d.length>0&&_.isEqual(d.data("nodeCacheMark"),MAPJS.DOMRender.nodeCacheMark(a,b))?_.pick(d.data(),"width","height"):(d=MAPJS.DOMRender.dummyTextBox,d.appendTo("body").updateNodeContent(a,e,b),c={width:d.outerWidth(!0),height:d.outerHeight(!0)},d.detach(),c)},layoutCalculator:function(a){"use strict";return MAPJS.calculateLayout(a,MAPJS.DOMRender.dimensionProvider,{theme:MAPJS.DOMRender.theme})},fixedLayout:!1},MAPJS.createSVG=function(a){"use strict";return jQuery(document.createElementNS("http://www.w3.org/2000/svg",a||"svg"))},jQuery.fn.getBox=function(){"use strict";var a=this&&this[0];return a?{top:a.offsetTop,left:a.offsetLeft,width:a.offsetWidth,height:a.offsetHeight}:!1},jQuery.fn.getDataBox=function(){"use strict";var a=this.data();return a&&a.width&&a.height?{top:a.y,left:a.x,width:a.width,height:a.height}:this.getBox()},jQuery.fn.animateConnectorToPosition=function(a,b){"use strict";var c=jQuery(this),d=c.data("nodeFrom"),e=c.data("nodeTo"),f=d&&d.getDataBox(),g=e&&e.getDataBox(),h={from:d&&d.getBox(),to:e&&e.getBox()};return b=b||1,f&&g&&h&&h.from.width===f.width&&h.to.width===g.width&&h.from.height===f.height&&h.to.height===g.height&&Math.abs(h.from.top-h.to.top-(f.top-g.top))<b&&Math.abs(h.from.left-h.to.left-(f.left-g.left))<b?(c.animate({left:Math.round(Math.min(f.left,g.left)),top:Math.round(Math.min(f.top,g.top))},a),!0):!1},jQuery.fn.queueFadeOut=function(a){"use strict";var b=this;return b.fadeOut(_.extend({complete:function(){b.is(":focus")&&b.parents("[tabindex]").focus(),b.remove()}},a))},jQuery.fn.queueFadeIn=function(a){"use strict";var b=this;return b.css("opacity",0).animate({opacity:1},_.extend({complete:function(){b.css("opacity","")}},a))},jQuery.fn.updateStage=function(){"use strict";var a=this.data(),b={"min-width":Math.round(a.width-a.offsetX),"min-height":Math.round(a.height-a.offsetY),width:Math.round(a.width-a.offsetX),height:Math.round(a.height-a.offsetY),"transform-origin":"top left",transform:"translate3d("+Math.round(a.offsetX)+"px, "+Math.round(a.offsetY)+"px, 0)"};return a.scale&&1!==a.scale&&(b.transform="scale("+a.scale+") translate("+Math.round(a.offsetX)+"px, "+Math.round(a.offsetY)+"px)"),this.css(b),this},MAPJS.DOMRender.appendUnderLine=function(a,b,c){"use strict";return b.nodeUnderline&&(a.d+="M"+(b.nodeUnderline.from.x-c.left)+","+(b.nodeUnderline.from.y-c.top)+" H"+(b.nodeUnderline.to.x-c.left)),a},jQuery.fn.updateConnector=function(a){"use strict";return jQuery.each(this,function(){var b,c,d,e,f,g=jQuery(this),h=g.data("nodeFrom"),i=g.data("nodeTo"),j=function(a,b){var c=a.data().innerRect;c&&(b.left+=c.dx,b.top+=c.dy,b.width=c.width,b.height=c.height)};return h&&i&&0!==h.length&&0!==i.length?(a?(d=h.getDataBox(),e=i.getDataBox()):(d=h.getBox(),e=i.getBox()),j(h,d),j(i,e),d.level=h.attr("mapjs-level"),e.level=i.attr("mapjs-level"),f={from:d,to:e,theme:MAPJS.DOMRender.theme&&MAPJS.DOMRender.theme.name},void(_.isEqual(f,g.data("changeCheck"))||(g.data("changeCheck",f),b=MAPJS.Connectors.themePath(d,e,MAPJS.DOMRender.theme),c=g.find("path"),g.css(b.position),0===c.length&&(c=MAPJS.createSVG("path").attr("class","mapjs-connector").appendTo(g)),c.attr("d",b.d)))):void g.hide()})},jQuery.fn.updateLink=function(){"use strict";return jQuery.each(this,function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n=jQuery(this),o=n.data("nodeFrom"),p=n.data("nodeTo"),q=n.find("path.mapjs-link"),r=n.find("path.mapjs-link-hit"),s=n.find("path.mapjs-arrow"),t=Math.tan(Math.PI/9),u={dashed:"8, 8",solid:""},v=_.pick(n.data(),"lineStyle","arrow","color");return o&&p&&0!==o.length&&0!==p.length?(b=o.getBox(),c=p.getBox(),d={from:b,to:c,attrs:v},void(_.isEqual(d,n.data("changeCheck"))||(n.data("changeCheck",d),a=MAPJS.Connectors.linkPath(b,c),n.css(a.position),0===q.length&&(q=MAPJS.createSVG("path").attr("class","mapjs-link").appendTo(n)),q.attr({d:a.d,"stroke-dasharray":u[v.lineStyle]}).css("stroke",v.color),0===r.length&&(r=MAPJS.createSVG("path").attr("class","mapjs-link-hit").appendTo(n)),r.attr({d:a.d}),v.arrow?(0===s.length&&(s=MAPJS.createSVG("path").attr("class","mapjs-arrow").appendTo(n)),i=14,l=a.conn.to.x-a.conn.from.x,m=a.conn.to.y-a.conn.from.y,0===l?(j=0>m?-1:1,e=a.conn.to.x+i*Math.sin(t)*j,g=a.conn.to.x-i*Math.sin(t)*j,f=a.conn.to.y-i*Math.cos(t)*j,h=a.conn.to.y-i*Math.cos(t)*j):(k=m/l,a.conn.from.x<a.conn.to.x&&(i=-i),e=a.conn.to.x+(1-k*t)*i/Math.sqrt((1+k*k)*(1+t*t)),f=a.conn.to.y+(k+t)*i/Math.sqrt((1+k*k)*(1+t*t)),g=a.conn.to.x+(1+k*t)*i/Math.sqrt((1+k*k)*(1+t*t)),h=a.conn.to.y+(k-t)*i/Math.sqrt((1+k*k)*(1+t*t))),s.attr("d","M"+Math.round(e-a.position.left)+","+Math.round(f-a.position.top)+"L"+Math.round(a.conn.to.x-a.position.left)+","+Math.round(a.conn.to.y-a.position.top)+"L"+Math.round(g-a.position.left)+","+Math.round(h-a.position.top)+"Z").css("fill",v.color).show()):s.hide()))):void n.hide()})},jQuery.fn.addNodeCacheMark=function(a){"use strict";this.data("nodeCacheMark",MAPJS.DOMRender.nodeCacheMark(a))},jQuery.fn.updateNodeContent=function(a,b,c){"use strict";var d,e,f=25,g=jQuery(this),h=function(){var a=g.find("[data-mapjs-role=title]");return 0===a.length&&(a=jQuery("<span>").attr("data-mapjs-role","title").appendTo(g)),a},i=function(){var a=g.find("[data-mapjs-role=decorations]");return 0===a.length&&(a=jQuery('<div data-mapjs-role="decorations" class="mapjs-decorations">').on("mousedown click",function(a){a.stopPropagation(),a.stopImmediatePropagation()}).appendTo(g)),a},j=function(a){var b=MAPJS.URLHelper.getLink(a),c=g.find("a.mapjs-hyperlink");return b?(0===c.length&&(c=jQuery('<a target="_blank" class="mapjs-hyperlink icon-hyperlink"></a>').addClass().appendTo(i())),void c.attr("href",b).show()):void c.hide()},k=function(a){var b=g.find(".mapjs-label");return a||0===a?(0===b.length&&(b=jQuery('<span class="mapjs-label"></span>').appendTo(i())),void b.text(a).show()):void b.hide()},l=function(){var b=a.attr&&a.attr.attachment,c=g.find("a.mapjs-attachment");return b?(0===c.length&&(c=jQuery('<a href="#" class="mapjs-attachment icon-attachment"></a>').appendTo(i()).click(function(){g.trigger("attachment-click"),g.trigger("decoration-click","attachment")})),void c.show()):void c.hide()},m=function(){var b=a.attr&&a.attr.note,c=g.find("a.mapjs-note");return b?(0===c.length&&(c=jQuery('<a href="#" class="mapjs-note icon-note"></a>').appendTo(i()).click(function(){g.trigger("decoration-click","note")})),void c.show()):void c.hide()},n=function(a){var b,c=MAPJS.URLHelper.stripLink(a)||(a.length<f?a:a.substring(0,f)+"..."),d=MAPJS.DOMRender.nodeTextPadding||11,e=h(),i=e[0];e.text(c.trim()),g.data("title",a),e.css({"max-width":"","min-width":""}),i.scrollWidth-d>i.offsetWidth?e.css("max-width",i.scrollWidth+"px"):(b=i.offsetHeight,e.css("min-width",e.css("max-width")),i.offsetHeight===b&&e.css("min-width",""))},o=function(){a.attr&&a.attr.collapsed?g.addClass("collapsed"):g.removeClass("collapsed")},p=function(b){var c=a.attr&&a.attr.style&&a.attr.style.background,d={color:"mapjs-node-light",lightColor:"mapjs-node-dark",darkColor:"mapjs-node-white"};"false"!==c&&"transparent"!==c||(c=!1),g.removeClass("mapjs-node-dark mapjs-node-white mapjs-node-light mapjs-node-colortext"),g.css({color:"","background-color":""}),c&&(b?g.css("color",c):(g.css("background-color",c),g.addClass(d[MAPJS.foregroundStyle(c)]))),b&&g.addClass("mapjs-node-colortext")},q=function(a){var c,d,e,f,i=h(),j={"min-height":"","min-width":"","background-image":"","background-repeat":"","background-size":"","background-position":""},k={"margin-top":"","margin-left":""};g.css({padding:""}),a&&(f=parseInt(g.css("padding-left"),10),c=i.outerHeight(),d=i.outerWidth(),e=parseInt(i.css("max-width"),10),_.extend(j,{"background-image":'url("'+(b?b(a.url):a.url)+'")',"background-repeat":"no-repeat","background-size":a.width+"px "+a.height+"px","background-position":"center center"}),"top"===a.position||"bottom"===a.position?("top"===a.position?j["background-position"]="center "+f+"px":MAPJS.DOMRender.fixedLayout?j["background-position"]="center "+(f+c)+"px":j["background-position"]="center "+a.position+" "+f+"px",j["padding-"+a.position]=a.height+2*f,j["min-width"]=a.width,a.width>e&&(k["margin-left"]=Math.round((a.width-e)/2))):"left"===a.position||"right"===a.position?("left"===a.position?j["background-position"]=f+"px center":MAPJS.DOMRender.fixedLayout?j["background-position"]=d+2*f+"px center ":j["background-position"]=a.position+" "+f+"px center",j["padding-"+a.position]=a.width+2*f,a.height>c&&(k["margin-top"]=Math.round((a.height-c)/2),j["min-height"]=a.height)):(a.height>c&&(k["margin-top"]=Math.round((a.height-c)/2),j["min-height"]=a.height),j["min-width"]=a.width,a.width>e&&(k["margin-left"]=Math.round((a.width-e)/2)))),g.css(j),i.css(k)},r=c||a.level,s=function(){var a=g[0];_.each(_.filter(a.classList,function(a){return/^level_.+/.test(a)}),function(b){a.classList.remove(b)}),a.classList.add("level_"+r),g.attr("mapjs-level",r)},t=function(a,b,c,d){return d},u=MAPJS.DOMRender.theme&&MAPJS.DOMRender.theme.attributeValue||t,v=u(["node"],["level_"+r,"default"],["border","type"],"surround"),w=u(["node"],["level_"+r,"default"],["decorations","edge"],""),x=u(["node"],["level_"+r,"default"],["decorations","overlap"],""),y="surround"!==v;return s(),n(a.title),j(a.title),k(a.label),m(),l(),d={x:Math.round(a.x),y:Math.round(a.y),width:Math.round(a.width),height:Math.round(a.height),nodeId:a.id},d.innerRect=_.pick(d,["width","height"]),d.innerRect.dx=0,d.innerRect.dy=0,this.css("margin",""),"left"===w?(d.innerRect.dx=i().outerWidth(),d.innerRect.width=d.width-i().outerWidth(),g.css("margin-left",i().outerWidth())):"right"===w?(d.innerRect.width=d.width-i().outerWidth(),g.css("margin-right",i().outerWidth())):"top"===w?(e=i().outerHeight()*(x?.5:1),d.innerRect.dy=e,d.innerRect.height=d.height-e,e&&g.css("margin-top",e)):"bottom"===w&&(e=i().outerHeight()*(x?.5:1),d.innerRect.height=d.height-e,g.css("margin-bottom",i().outerHeight()*(x?.5:1))),g.data(d).addNodeCacheMark(a),p(y),q(a.attr&&a.attr.icon),o(),g},jQuery.fn.placeCaretAtEnd=function(){"use strict";var a,b,c,d=this[0];window.getSelection&&document.createRange?(a=document.createRange(),a.selectNodeContents(d),a.collapse(!1),b=window.getSelection(),b.removeAllRanges(),b.addRange(a)):document.body.createTextRange&&(c=document.body.createTextRange(),c.moveToElementText(d),c.collapse(!1),c.select())},jQuery.fn.selectAll=function(){"use strict";var a,b,c,d=this[0];window.getSelection&&document.createRange?(a=document.createRange(),a.selectNodeContents(d),b=window.getSelection(),b.removeAllRanges(),b.addRange(a)):document.body.createTextRange&&(c=document.body.createTextRange(),c.moveToElementText(d),c.select())},jQuery.fn.innerText=function(){"use strict";var a=this.html(),b=/<br\/?>/.test(a),c=/<div>/.test(a);return c&&this[0].innerText?this[0].innerText.trim():b?a.replace(/<br\/?>/gi,"\n").replace(/(<([^>]+)>)/gi,""):this.text()},jQuery.fn.editNode=function(a){"use strict";var b=this,c=this.find("[data-mapjs-role=title]"),d=this.data("title"),e=c.text(),f=jQuery.Deferred(),g=function(){l(),c.css("word-break",""),c.removeAttr("contenteditable"),b.shadowDraggable()},h=function(){var a=c.innerText();return a===d?i():(g(),void f.resolve(a))},i=function(){g(),c.text(e),f.reject()},j=function(a){var b=13,e=27,f=9,g=83,j=90;a.shiftKey&&a.which===b||(a.which===b?(h(),a.stopPropagation()):a.which===e?(i(),a.stopPropagation()):a.which===f||a.which===g&&(a.metaKey||a.ctrlKey)&&!a.altKey?(h(),a.preventDefault()):a.shiftKey||a.which!==j||!a.metaKey&&!a.ctrlKey||a.altKey||(c.text()===d&&i(),a.stopPropagation()))},k=function(){c.on("blur",h).on("keydown",j)},l=function(){c.off("blur",h).off("keydown",j)};return k(),d!==e&&c.css("word-break","break-all"),c.text(d).attr("contenteditable",!0).focus(),a?c.selectAll():d&&c.placeCaretAtEnd(),b.shadowDraggable({disable:!0}),f.promise()},jQuery.fn.updateReorderBounds=function(a,b,c){"use strict";var d=this;return a?(d.show(),d.attr("mapjs-edge",a.edge),void("top"===a.edge?d.css({top:a.minY,left:Math.round(c.x-d.width()/2)}):d.css({top:Math.round(c.y-d.height()/2),left:a.x-("left"===a.edge?d.width():0)}))):void d.hide()},function(){"use strict";var a=function(a){return a.replace(/[^A-Za-z0-9_-]/g,"_")},b=function(b){return a("connector_"+b.from+"_"+b.to)},c=function(b){return a("link_"+b.ideaIdFrom+"_"+b.ideaIdTo)},d=function(b){return a("node_"+b)};jQuery.fn.createNode=function(a){return jQuery("<div>").attr({id:d(a.id),tabindex:0,"data-mapjs-role":"node"}).css({display:"block",position:"absolute"}).addClass("mapjs-node").appendTo(this)},jQuery.fn.createConnector=function(a){return MAPJS.createSVG().attr({id:b(a),"data-mapjs-role":"connector","class":"mapjs-draw-container"}).data({nodeFrom:this.nodeWithId(a.from),nodeTo:this.nodeWithId(a.to)}).appendTo(this)},jQuery.fn.createLink=function(a){var b=_.extend({color:"red",lineStyle:"dashed"},a.attr&&a.attr.style);return MAPJS.createSVG().attr({id:c(a),"data-mapjs-role":"link","class":"mapjs-draw-container"}).data({nodeFrom:this.nodeWithId(a.ideaIdFrom),nodeTo:this.nodeWithId(a.ideaIdTo)}).data(b).appendTo(this)},jQuery.fn.nodeWithId=function(a){return this.find("#"+d(a))},jQuery.fn.findConnector=function(a){return this.find("#"+b(a))},jQuery.fn.findLink=function(a){return this.find("#"+c(a))},jQuery.fn.createReorderBounds=function(){var a=jQuery("<div>").attr({"data-mapjs-role":"reorder-bounds","class":"mapjs-reorder-bounds"}).hide().css("position","absolute").appendTo(this);return a}}(),MAPJS.DOMRender.viewController=function(a,b,c,d,e,f){"use strict";var g,h=b.parent(),i=jQuery(),j=jQuery(),k={duration:400,queue:"nodeQueue",easing:"linear"},l=a.isEditingEnabled()?b.createReorderBounds():jQuery("<div>"),m=function(){return g?g:g={left:h.scrollLeft(),top:h.scrollTop(),innerWidth:h.innerWidth(),innerHeight:h.innerHeight()}},n=function(a,c){var d=b.data(),e=m();return{x:d.scale*(a+d.offsetX)-e.left,y:d.scale*(c+d.offsetY)-e.top}},o=function(a,c){var d=b.data(),e=m();return{x:(e.left+a)/d.scale-d.offsetX,y:(e.top+c)/d.scale-d.offsetY}},p=function(){var a=jQuery(this);a.css({left:a.data("x"),top:a.data("y")}).trigger("mapjs:move")},q=function(){var a=jQuery(this);a.clearQueue(k.queue).animate({left:a.data("x"),top:a.data("y"),opacity:1},_.extend({complete:function(){a.css("opacity",""),a.each(p)}},k)).trigger("mapjs:animatemove")},r=function(a,c){var d=b.data(),e=!1;a<-1*d.offsetX&&(d.width=d.width-d.offsetX-a,d.offsetX=-1*a,e=!0),c<-1*d.offsetY&&(d.height=d.height-d.offsetY-c,d.offsetY=-1*c,e=!0),a>d.width-d.offsetX&&(d.width=d.offsetX+a,e=!0),c>d.height-d.offsetY&&(d.height=d.offsetY+c,e=!0),e&&b.updateStage()},s=function(){return jQuery(this).each(function(){var a=jQuery(this).data(),b=MAPJS.DOMRender.stageMargin||{top:0,left:0,bottom:0,right:0};r(a.x-b.left,a.y-b.top),r(a.x+a.width+b.right,a.y+a.height+b.bottom)})},t=function(a,c,d){var e,f,g=b.data(),i={x:Math.round(h.innerWidth()/2),y:Math.round(h.innerHeight()/2)},j=MAPJS.DOMRender.stageVisibilityMargin||{top:0,left:0,bottom:0,right:0};r(a-i.x/g.scale,c-i.y/g.scale),r(a+i.x/g.scale-j.left,c+i.y/g.scale-j.top),e=g.scale*(a+g.offsetX)-i.x,f=g.scale*(c+g.offsetY)-i.y,h.finish(),d?h.animate({scrollLeft:e,scrollTop:f},{duration:400}):(h.scrollLeft(e),h.scrollTop(f))},u=function(){return o(Math.round(h.innerWidth()/2),Math.round(h.innerHeight()/2))},v=function(a){var b,c,d,e,f;a&&0!==a.length&&(h.finish(),b=a.data(),c=n(b.x,b.y),d=n(b.x+b.width,b.y+b.height),e={},f=MAPJS.DOMRender.stageVisibilityMargin||{top:10,left:10,bottom:10,right:10},c.x-f.left<0?e.scrollLeft=h.scrollLeft()+c.x-f.left:d.x+f.right>h.innerWidth()&&(e.scrollLeft=h.scrollLeft()+d.x-h.innerWidth()+f.right),c.y-f.top<0?e.scrollTop=h.scrollTop()+c.y-f.top:d.y+f.bottom>h.innerHeight()&&(e.scrollTop=h.scrollTop()+d.y-h.innerHeight()+f.bottom),_.isEmpty(e)||h.animate(e,{duration:100}))},w=function(a){var b,c=a&&a.gesture&&a.gesture.center||a,d=h.offset();return c&&(b={x:c.pageX-d.left,y:c.pageY-d.top},b.x>=0&&b.x<=h.innerWidth()&&b.y>=0&&b.y<=h.innerHeight())?b:void 0},x=function(a){var b=w(a);return b?o(b.x,b.y):void 0},y=function(){(A||A===!1)&&(jQuery(".mapjs-node").removeClass("droppable"),A=void 0)},z=function(a){b.nodeWithId(a).addClass("droppable"),A=a},A=!1,B=function(a,b){var c=function(a){var c=b.x;return"right"===a.edge&&(c+=b.width),a.x&&a.margin?Math.abs(c-a.x)<2*a.margin&&b.y<a.maxY&&b.y>a.minY:b.y<a.maxY&&b.y>a.minY&&b.x<a.maxX&&b.x>a.minX};return _.isEmpty(a)?!1:b?_.find(a,c):!1};h.on("scroll",function(){g=void 0}),d&&d.addEventListener("imageInserted",function(b,c,d,e){var f=x(e);a.dropImage(b,c,d,f&&f.x,f&&f.y)}),a.addEventListener("nodeCreated",function(d){var f,g=b.createNode(d).queueFadeIn(k).updateNodeContent(d,e).on("tap",function(b){var c=b.gesture&&b.gesture.srcEvent||b;c.button&&-1!==c.button||(a.clickNode(d.id,c),b&&b.stopPropagation(),b&&b.gesture&&b.gesture.stopPropagation())}).on("doubletap",function(b){return b&&(b.stopPropagation(),b.gesture&&b.gesture.stopPropagation()),a.isEditingEnabled()?void a.editNode("mouse"):void a.toggleCollapse("mouse")}).on("attachment-click",function(){a.openAttachment("mouse",d.id)}).on("decoration-click",function(b,c){a.decorationAction("mouse",d.id,c)}).each(s).each(p).on("mm:start-dragging mm:start-dragging-shadow",function(){a.selectNode(d.id),f=a.getReorderBoundary(d.id),g.addClass("dragging")}).on("mm:drag",function(b){var c,e,h=x(b),i=b.currentPosition&&x({pageX:b.currentPosition.left,pageY:b.currentPosition.top}),j=b&&b.gesture&&b.gesture.srcEvent&&b.gesture.srcEvent.shiftKey;return h?(c=a.getNodeIdAtPosition(h.x,h.y),j||c||!i?l.hide():(i.width=g.outerWidth(),i.height=g.outerHeight(),e=B(f,i),l.updateReorderBounds(e,i,h)),void(c&&c!==d.id?c!==A&&(y(),c&&z(c)):y())):void y()}).on("contextmenu",function(b){return a.selectNode(d.id),a.requestContextMenu(b.pageX,b.pageY)?(b.preventDefault(),!1):void 0}).on("mm:stop-dragging",function(b){var c,e,h,i,j,k,m;return g.removeClass("dragging"),l.hide(),c=b&&b.gesture&&b.gesture.srcEvent&&b.gesture.srcEvent.shiftKey,e=x(b),y(),e?(h=a.getNodeIdAtPosition(e.x,e.y),i=x({pageX:b.finalPosition.left,pageY:b.finalPosition.top}),h&&h!==d.id?j=a.dropNode(d.id,h,!!c):d.level>1?(i.width=g.outerWidth(),i.height=g.outerHeight(),k=!!c||!B(f,i),j=k?a.positionNodeAt(d.id,i.x,i.y,k):a.positionNodeAt(d.id,e.x,e.y,k)):1===d.level&&b.gesture?(m=u(),m.x-=b.gesture.deltaX||0,m.y-=b.gesture.deltaY||0,t(m.x,m.y,!0),j=!0):j=!1,j):void 0}).on("mm:cancel-dragging",function(){y(),g.removeClass("dragging"),l.hide()});c&&g.on("hold",function(b){var c=b.gesture&&b.gesture.srcEvent||b;return a.clickNode(d.id,c),a.requestContextMenu(b.gesture.center.pageX,b.gesture.center.pageY)?(b.preventDefault(),b.gesture&&(b.gesture.preventDefault(),b.gesture.stopPropagation()),!1):void 0}),g.css("min-width",g.css("width")),a.isEditingEnabled()&&g.shadowDraggable()}),a.addEventListener("nodeSelectionChanged",function(a,c){var d=b.nodeWithId(a);c?(d.addClass("selected"),v(d)):d.removeClass("selected")}),a.addEventListener("nodeRemoved",function(a){b.nodeWithId(a.id).queueFadeOut(k)}),a.addEventListener("nodeMoved",function(a){var c=m(),d=b.nodeWithId(a.id).data({x:Math.round(a.x),y:Math.round(a.y),width:Math.round(a.width),height:Math.round(a.height)}).each(s),e=n(Math.round(a.x),Math.round(a.y)),f=n(Math.round(a.x+a.width),Math.round(a.y+a.height));f.x<0||f.y<0||e.x>c.innerWidth||e.y>c.innerHeight?d.each(p):d.each(q)}),a.addEventListener("nodeTitleChanged nodeAttrChanged nodeLabelChanged",function(a){b.nodeWithId(a.id).updateNodeContent(a,e)}),a.addEventListener("connectorCreated",function(a){var c=b.createConnector(a).queueFadeIn(k).updateConnector(!0);b.nodeWithId(a.from).add(b.nodeWithId(a.to)).on("mapjs:move",function(){c.updateConnector(!0)}).on("mm:drag",function(){c.updateConnector()}).on("mapjs:animatemove",function(){i=i.add(c)})}),a.addEventListener("connectorRemoved",function(a){b.findConnector(a).queueFadeOut(k)}),a.addEventListener("linkCreated",function(c){var d=b.createLink(c).queueFadeIn(k).updateLink();d.find(".mapjs-link-hit").on("tap",function(b){a.selectLink("mouse",c,{x:b.gesture.center.pageX,y:b.gesture.center.pageY}),b.stopPropagation(),b.gesture.stopPropagation()}),b.nodeWithId(c.ideaIdFrom).add(b.nodeWithId(c.ideaIdTo)).on("mapjs:move mm:drag",function(){d.updateLink()}).on("mapjs:animatemove",function(){j=j.add(d)})}),a.addEventListener("linkRemoved",function(a){b.findLink(a).queueFadeOut(k)}),a.addEventListener("mapScaleChanged",function(a){var c=b.data("scale"),d=Math.max(Math.min(c*a,5),.2),e=u();c!==d&&(b.data("scale",d).updateStage(),t(e.x,e.y))}),a.addEventListener("nodeVisibilityRequested",function(c){var d=c||a.getCurrentlySelectedIdeaId(),e=b.nodeWithId(d);e&&(v(e),h.finish())}),a.addEventListener("nodeFocusRequested",function(a){var c=b.nodeWithId(a).data(),d=Math.round(c.x+c.width/2),e=Math.round(c.y+c.height/2);1!==b.data("scale")&&b.data("scale",1).updateStage(),t(d,e,!0)}),a.addEventListener("mapViewResetRequested",function(){b.data({scale:1,height:0,width:0,offsetX:0,offsetY:0}).updateStage(),b.children().andSelf().finish(k.queue),jQuery(b).find(".mapjs-node").each(s),jQuery(b).find("[data-mapjs-role=connector]").updateConnector(!0),jQuery(b).find("[data-mapjs-role=link]").updateLink(!0),t(0,0),h.focus()}),a.addEventListener("layoutChangeStarting",function(){g=void 0,b.children().finish(k.queue),b.finish(k.queue)}),a.addEventListener("layoutChangeComplete",function(c){var d=jQuery(),e=jQuery();c&&c.themeChanged?(b.children().andSelf().finish(k.queue),jQuery(b).find("[data-mapjs-role=connector]").updateConnector(!0),jQuery(b).find("[data-mapjs-role=link]").updateLink(!0)):(i.each(function(){jQuery(this).animateConnectorToPosition(k,2)||(d=d.add(this))}),j.each(function(){jQuery(this).animateConnectorToPosition(k,2)||(e=e.add(this))}),b.animate({opacity:1},_.extend({progress:function(){d.updateConnector(),e.updateLink()},complete:function(){d.updateConnector(!0),e.updateLink(!0)}},k)),b.children().dequeue(k.queue),b.dequeue(k.queue)),i=jQuery(),j=jQuery(),v(b.nodeWithId(a.getCurrentlySelectedIdeaId()))}),f&&f.inlineEditingDisabled||a.addEventListener("nodeEditRequested",function(c,d,e){var f=b.nodeWithId(c);a.setInputEnabled(!1),h.finish(),f.editNode(d).done(function(b){a.setInputEnabled(!0),a.updateTitle(c,b,e),f.focus()}).fail(function(){a.setInputEnabled(!0),e&&a.undo("internal"),f.focus()})}),a.addEventListener("addLinkModeToggled",function(a){a?b.addClass("mapjs-add-link"):b.removeClass("mapjs-add-link")}),a.addEventListener("linkAttrChanged",function(a){var c=_.extend({arrow:!1},a.attr&&a.attr.style);b.findLink(a).data(c).updateLink()}),a.addEventListener("activatedNodesChanged",function(a,c){_.each(a,function(a){b.nodeWithId(a).addClass("activated")}),_.each(c,function(a){b.nodeWithId(a).removeClass("activated")})})},jQuery.fn.scrollWhenDragging=function(a){"use strict";return this.each(function(){var b,c=$(this);c.on("dragstart",function(){a()&&(b={top:c.scrollTop(),left:c.scrollLeft()})}).on("drag",function(a){a.gesture&&b&&(c.scrollTop(b.top-a.gesture.deltaY),c.scrollLeft(b.left-a.gesture.deltaX))}).on("dragend",function(){b=void 0})})},$.fn.domMapWidget=function(a,b,c,d,e,f,g,h){"use strict";var i={"return":"insertDown","shift+return":"insertUp","shift+tab":"insertLeft","tab insert":"insertRight","del backspace":"removeSubIdea",left:"selectNodeLeft",up:"selectNodeUp",right:"selectNodeRight","shift+right":"activateNodeRight","shift+left":"activateNodeLeft","meta+right ctrl+right":"moveRight","meta+left ctrl+left":"moveLeft","meta+up ctrl+up":"moveUp","meta+down ctrl+down":"moveDown","shift+up":"activateNodeUp","shift+down":"activateNodeDown",down:"selectNodeDown","space f2":"editNode",f:"toggleCollapse","c meta+x ctrl+x":"cut","p meta+v ctrl+v":"paste","y meta+c ctrl+c":"copy","u meta+z ctrl+z":"undo","Esc 0 meta+0 ctrl+0":"resetView","r meta+shift+z ctrl+shift+z meta+y ctrl+y":"redo","meta+plus ctrl+plus z":"scaleUp","meta+minus ctrl+minus shift+z":"scaleDown","ctrl+shift+v meta+shift+v":"pasteStyle",Esc:"cancelCurrentAction"},j={"[":"activateChildren","{":"activateNodeAndChildren","=":"activateSiblingNodes",".":"activateSelectedNode","/":"toggleCollapse",a:"openAttachment",i:"editIcon"},k=!0,l=this;return b.addEventListener("inputEnabledChanged",function(a,b){k=a,a&&!b&&l.focus()}),this.each(function(){var a=$(this),l=$("<div>").css({position:"relative"}).attr("data-mapjs-role","stage").appendTo(a).data({offsetX:a.innerWidth()/2,offsetY:a.innerHeight()/2,width:a.innerWidth()-20,height:a.innerHeight()-20,scale:1}).updateStage(),m=!1;a.css("overflow","auto").attr("tabindex",1),b.isEditingEnabled()&&(e||a).simpleDraggableContainer(),c?a.on("doubletap",function(a){return b.requestContextMenu(a.gesture.center.pageX,a.gesture.center.pageY)?(a.preventDefault(),a.gesture.preventDefault(),!1):void 0}).on("pinch",function(a){if(a&&a.gesture&&a.gesture.scale){a.preventDefault(),a.gesture.preventDefault();var c=a.gesture.scale;m&&(c/=m),Math.abs(c-1)<.05||(m=a.gesture.scale,b.scale("touch",c,{x:a.gesture.center.pageX-l.data("offsetX"),y:a.gesture.center.pageY-l.data("offsetY")}))}}).on("gestureend",function(){m=!1}):(a.scrollWhenDragging(b.getInputEnabled),a.on("mousedown",function(b){b.target!==a[0]&&a.css("overflow","hidden")}),jQuery(document).on("mouseup",function(){"auto"!==a.css("overflow")&&a.css("overflow","auto")}),a.imageDropWidget(d)),MAPJS.DOMRender.viewController(b,l,c,d,f,h),_.each(i,function(c,d){a.keydown(d,function(a){k&&(a.stopImmediatePropagation(),a.preventDefault(),b[c]("keyboard"))})}),c||jQuery(window).on("resize",function(){b.resetView()}),jQuery(window).on("orientationchange",function(){g?b.centerOnNode(b.getSelectedNodeId()):b.resetView()}),jQuery(document).on("keydown",function(a){var c,d={"U+003D":"scaleUp","U+002D":"scaleDown",61:"scaleUp",173:"scaleDown"};a&&!a.altKey&&(a.ctrlKey||a.metaKey)&&(a.originalEvent&&a.originalEvent.keyIdentifier?c=d[a.originalEvent.keyIdentifier]:"MozPrintableKey"===a.key&&(c=d[a.which]),c&&k&&(a.preventDefault(),b[c]("keyboard")))}).on("wheel mousewheel",function(b){var c=b.originalEvent.deltaX||-1*b.originalEvent.wheelDeltaX;0>c&&0===a.scrollLeft()&&b.preventDefault(),c>0&&a[0].scrollWidth-a.width()-a.scrollLeft()===0&&b.preventDefault()}),a.on("keypress",function(a){if(k&&!/INPUT|TEXTAREA/.test(a&&a.target&&a.target.tagName)){var c=a.charCode||a.keyCode,d=String.fromCharCode(c),e=j[d];e?(a.preventDefault(),b[e]("keyboard")):Number(d)<=9&&Number(d)>=1&&(a.preventDefault(),b.activateLevel("keyboard",Number(d)+1))}})})},$.fn.themeCssWidget=function(a,b,c){"use strict";var d=$(this),e=function(c){var e=a[c||"default"];e&&(MAPJS.DOMRender.theme=new MAPJS.Theme(e),d.text(b.process(e).css))};return e("default"),c.addEventListener("themeChanged",e),d},MAPJS.observable=observable,module.exports=MAPJS;
//# sourceMappingURL=index.js.map